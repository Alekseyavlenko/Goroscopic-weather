import csv
import os
import random
import sqlite3


# ----------------------------
# функция из presckazaniye.py
# ----------------------------

def get_random_prediction(zodiac_sign):
    conn = sqlite3.connect('goroscope.db')
    cursor = conn.cursor()
    cursor.execute('SELECT prediction FROM predictions WHERE zodiac_sign = ?', (zodiac_sign,))
    predictions = cursor.fetchall()
    conn.close()
    if predictions:
        return random.choice(predictions)[0]
    else:
        return None


# ----------------------------
# функции из registration.py
# ----------------------------

def get_next_id():
    if not os.path.exists('data/users.csv'):
        return 0
    with open('data/users.csv', 'r', encoding='utf-8') as file:
        reader = csv.reader(file, delimiter=';', quotechar='"')
        return sum(1 for _ in reader) - 1


def save_user_csv(username, password, goroscope):
    file_exists = os.path.isfile('data/users.csv')
    os.makedirs('data', exist_ok=True)  # Создаём папку, если нет
    with open('data/users.csv', 'a', newline='', encoding='utf-8') as file:
        writer = csv.writer(file, delimiter=';', quotechar='"')
        if not file_exists:
            writer.writerow(['id', 'username', 'password', 'goroscope'])
        writer.writerow([get_next_id(), username, password, goroscope])


# ----------------------------
# функции из registr.py
# ----------------------------

def init_db():
    conn = sqlite3.connect('registr.db')
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password TEXT NOT NULL,
            wants_horoscope INTEGER NOT NULL
        )
    ''')
    conn.commit()
    conn.close()


def save_user_sqlite(username, password, wants_horoscope):
    conn = sqlite3.connect('goroscope.db')
    cursor = conn.cursor()
    try:
        cursor.execute(
            'INSERT INTO users (username, password, wants_horoscope) VALUES (?, ?, ?)',
            (username, password, wants_horoscope)
        )
        conn.commit()
    except sqlite3.IntegrityError:
        conn.close()
        return False
    conn.close()
    return True


# ----------------------------
# код из goroscop.py
# ----------------------------

def init_goroscope_db():
    conn = sqlite3.connect('goroscope.db')
    cursor = conn.cursor()

    # создание таблицы predictions
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS predictions (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        zodiac_sign TEXT NOT NULL,
        prediction TEXT NOT NULL
    )
    ''')

    zodiac_predictions = {
        'Овен': [
            "Сегодня звёзды благоволят смелым решениям - действуйте без колебаний!",
            "Ваша энергия притягивает удачу, используйте это время для старта новых проектов.",
            "Неожиданная встреча изменит ваши планы в лучшую сторону.",
            "Сосредоточьтесь на финансовых вопросах - возможны выгодные предложения.",
            "Рискните попробовать что-то новое - это принесёт неожиданные плоды.",
            "Спортивная активность поможет выплеснуть накопившуюся энергию.",
            "Проявите инициативу в личных отношениях - партнёр ждёт вашего шага."
        ],
        'Телец': [
            "Сегодня идеальный день для укрепления семейных связей.",
            "Проявите гибкость в рабочих вопросах - это принесёт уважение коллег.",
            "Долгожданное известие принесёт облегчение.",
            "Не поддавайтесь на провокации - сохраняйте спокойствие.",
            "Творческая деятельность принесёт моральное удовлетворение.",
            "Пересмотр бюджета откроет скрытые резервы.",
            "Романтический ужин укрепит доверие в паре."
        ],
        'Близнецы': [
            "Неожиданное предложение заставит пересмотреть планы.",
            "Сегодня лучше слушать, чем говорить - вы узнаете важную информацию.",
            "Поездка принесёт новые деловые контакты.",
            "Доверьтесь интуиции в личных отношениях.",
            "Финансовая стабильность потребует перераспределения ресурсов.",
            "Утренний ритуал задаст продуктивный настрой на день.",
            "Совместный проект с другом принесёт взаимную выгоду."
        ],
        'Рак': [
            "Эмоциональная поддержка близких придаст сил.",
            "Сегодня проявите инициативу в карьерных вопросах.",
            "Старые обиды лучше оставить в прошлом.",
            "Творческий подход к рутинным делам принесёт успех.",
            "Внимание к здоровью предотвратит возможные проблемы.",
            "Письмо или сообщение изменит ваше отношение к ситуации.",
            "Вечерняя прогулка поможет привести мысли в порядок."
        ],
        'Лев': [
            "Яркое событие привлечёт внимание окружающих.",
            "Финансовые вложения потребуют осторожности.",
            "Романтическое приключение взбодрит и вдохновит.",
            "Не бойтесь делегировать полномочия - это сэкономит время.",
            "Спонтанное решение окажется верным.",
            "Обновление гардероба повысит уверенность в себе.",
            "Семейный совет поможет избежать ошибки."
        ],
        'Дева': [
            "Анализ прошлых ошибок поможет избежать новых.",
            "Сегодня лучше работать в одиночестве - коллектив мешает концентрации.",
            "Покупка техники потребует внимательного выбора.",
            "Поездка за город принесёт душевное равновесие.",
            "Тайный поклонник проявит себя неожиданным образом.",
            "Старый документ потребует срочного внимания.",
            "Медитативные практики восстановят душевный баланс."
        ],
        'Весы': [
            "Компромисс в споре сохранит важные отношения.",
            "Хобби может перерасти в источник дохода.",
            "Избегайте импульсивных трат - составьте бюджет.",
            "Старая дружба обретёт новое значение.",
            "Работа над имиджем принесёт профессиональные дивиденды.",
            "Неожиданный комплимент поднимет настроение.",
            "Совместное творчество сблизит с партнёром."
        ],
        'Скорпион': [
            "Скрытые мотивы партнёра станут очевидными.",
            "Инвестиции в образование окупятся сторицей.",
            "Сегодня проявите снисходительность к чужим слабостям.",
            "Физическая активность поможет снять стресс.",
            "Ваша настойчивость сломает чьё-то сопротивление.",
            "Тайное становится явным - будьте готовы к откровениям.",
            "Ночные размышления приведут к важному решению."
        ],
        'Стрелец': [
            "Мечты требуют конкретных действий - составьте план.",
            "Командировка принесёт полезные знакомства.",
            "Юмор поможет выйти из неловкой ситуации.",
            "Внимание к деталям предотвратит ошибку.",
            "Новый гаджет значительно упростит работу.",
            "Поездка в незнакомое место расширит кругозор.",
            "Спонтанное обучение новому навыку пригодится в будущем."
        ],
        'Козерог': [
            "Терпение в достижении цели приведёт к успеху.",
            "Семейный совет поможет принять верное решение.",
            "Работа с документами потребует особой внимательности.",
            "Спонтанное путешествие зарядит энергией.",
            "Старый друг обратится за помощью - не отказывайте.",
            "Утренняя рутина станет источником вдохновения.",
            "Финансовая дисциплина предотвратит ненужные траты."
        ],
        'Водолей': [
            "Новаторская идея найдёт поддержку у начальства.",
            "Романтические отношения выйдут на новый уровень.",
            "Финансовая помощь близких решит текущие проблемы.",
            "Эксперимент с внешностью поднимет самооценку.",
            "Ваше красноречие поможет убедить оппонентов.",
            "Техническая неполадка обернётся неожиданным плюсом.",
            "Волонтёрская деятельность принесёт моральное удовлетворение."
        ],
        'Рыбы': [
            "Интуиция подскажет верное решение в сложной ситуации.",
            "Творческий проект получит неожиданное развитие.",
            "Избегайте конфликтов на пустом месте.",
            "Помощь незнакомца удивит и обрадует.",
            "Финансовая стабильность позволит сделать важную покупку.",
            "Водные процедуры снимут эмоциональное напряжение.",
            "Старая фотография вдохновит на новые свершения."
        ]
    }

    # заполнение таблицы predictions
    cursor.execute('SELECT COUNT(*) FROM predictions')
    count = cursor.fetchone()[0]
    if count == 0:
        for sign, predictions in zodiac_predictions.items():
            for text in predictions:
                cursor.execute(
                    'INSERT INTO predictions (zodiac_sign, prediction) VALUES (?, ?)',
                    (sign, text)
                )
        conn.commit()

    conn.close()


if __name__ == '__main__':
    init_db()
    init_goroscope_db()
